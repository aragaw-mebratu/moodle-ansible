---
- name: Validate Moodle Deployment
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    moodle_namespace: "{{ lookup('env', 'MOODLE_NAMESPACE') | default('moodle', true) }}"
    
  pre_tasks:
    - name: In-cluster authentication notice
      debug:
        msg: |
          Using in-cluster authentication via ServiceAccount token.
          No kubeconfig file needed when running inside Kubernetes.
          Ensure AWX ServiceAccount has RBAC permissions for {{ moodle_namespace }} namespace.
      delegate_to: localhost
      run_once: true
    
    - name: Check if moodle namespace exists
      kubernetes.core.k8s_info:
        kind: Namespace
        name: "{{ moodle_namespace }}"
      register: namespace_check
      ignore_errors: true
    
    - name: Set namespace existence fact
      set_fact:
        namespace_exists: >-
          {{
            namespace_check.resources is defined and
            namespace_check.resources is not none and
            namespace_check.resources | length > 0
          }}
      delegate_to: localhost
      run_once: true
    
    - name: Fail if namespace doesn't exist
      fail:
        msg: |
          Moodle namespace '{{ moodle_namespace }}' does not exist!
          
          Troubleshooting:
          1. Create the namespace: kubectl create namespace {{ moodle_namespace }}
          2. Deploy Moodle to the namespace
          3. Or set MOODLE_NAMESPACE environment variable to the correct namespace
      when: not namespace_exists
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Check if moodle namespace exists
      kubernetes.core.k8s_info:
        kind: Namespace
        name: "{{ moodle_namespace }}"
      register: namespace_info
      ignore_errors: true
      
    - name: Set namespace existence fact
      set_fact:
        namespace_exists: "{{ (namespace_info.resources | length > 0) if (namespace_info.get('resources') is defined and namespace_info.resources is not none) else false }}"
    
    - name: Fail if namespace doesn't exist
      fail:
        msg: "Moodle namespace '{{ moodle_namespace }}' does not exist"
      when: not namespace_exists

    - name: Check deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        name: moodle
        namespace: "{{ moodle_namespace }}"
      register: deployment_info
      
    - name: Set deployment status fact
      set_fact:
        deployment_available: "{{ (deployment_info.resources[0].status.availableReplicas is defined and deployment_info.resources[0].status.availableReplicas > 0) if (deployment_info.get('resources') is defined and deployment_info.resources is not none and deployment_info.resources | length > 0) else false }}"
        deployment_exists: "{{ (deployment_info.resources | length > 0) if (deployment_info.get('resources') is defined and deployment_info.resources is not none) else false }}"
        
    - name: Check pod status
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ moodle_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=moodle
      register: pod_info
      
    - name: Set pod facts
      set_fact:
        total_pods: "{{ (pod_info.resources | length) if (pod_info.get('resources') is defined and pod_info.resources is not none) else 0 }}"
        ready_pods: "{{ ((pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list) | length) if (pod_info.get('resources') is defined and pod_info.resources is not none and (pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list)) else 0 }}"
        
    - name: Check service status
      kubernetes.core.k8s_info:
        kind: Service
        name: moodle
        namespace: "{{ moodle_namespace }}"
      register: service_info
      
    - name: Set service facts
      set_fact:
        service_exists: "{{ (service_info.resources | length > 0) if (service_info.get('resources') is defined and service_info.resources is not none) else false }}"
        service_data: "{{ service_info.resources[0] if (service_info.get('resources') is defined and service_info.resources is not none and service_info.resources | length > 0) else {} }}"
        
    - name: Check database secret
      kubernetes.core.k8s_info:
        kind: Secret
        name: moodle-externaldb
        namespace: "{{ moodle_namespace }}"
      register: secret_info
      
    - name: Set secret facts
      set_fact:
        secret_exists: "{{ (secret_info.resources | length > 0) if (secret_info.get('resources') is defined and secret_info.resources is not none) else false }}"
      
    - name: Check configmap
      kubernetes.core.k8s_info:
        kind: ConfigMap
        name: moodle-config-synchronized
        namespace: "{{ moodle_namespace }}"
      register: configmap_info
      ignore_errors: true
      
    - name: Set configmap facts
      set_fact:
        configmap_exists: "{{ (configmap_info.resources | length > 0) if (configmap_info.get('resources') is defined and configmap_info.resources is not none) else false }}"
      
    - name: Display validation results
      debug:
        msg:
          - "=== MOODLE DEPLOYMENT VALIDATION ==="
          - "Namespace: {{ '✓ Present' if namespace_exists else '✗ Missing' }}"
          - "Deployment: {{ '✓ Available' if deployment_available else '✗ Not Available' }}"
          - "Pods: {{ ready_pods }}/{{ total_pods }} ready"
          - "Service: {{ '✓ Present' if service_exists else '✗ Missing' }}"
          - "Database Secret: {{ '✓ Present' if secret_exists else '✗ Missing' }}"
          - "ConfigMap: {{ '✓ Present' if configmap_exists else '✗ Missing' }}"
          - ""
          - "=== ACCESS INFORMATION ==="
          - "NodePort: {{ service_data.spec.ports[0].nodePort | default('Unknown') if service_data.get('spec', {}).get('ports', []) | length > 0 else 'Unknown' }}"
          - "ClusterIP: {{ service_data.spec.clusterIP | default('Unknown') if service_data.get('spec', {}).get('clusterIP') is defined else 'Unknown' }}"
          
    - name: Fail if deployment is not healthy
      fail:
        msg: "Moodle deployment is not healthy. Check the status above."
      when: >
        not deployment_available or
        ready_pods == 0
        
    - name: Success message
      debug:
        msg: "✅ Moodle deployment validation successful!"
      when: >
        deployment_available and
        ready_pods != 0