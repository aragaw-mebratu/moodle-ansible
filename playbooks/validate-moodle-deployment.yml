---
- name: Validate Moodle Deployment
  hosts: localhost
  connection: local
  gather_facts: false
  
  vars:
    moodle_namespace: "moodle"
    kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') | default('/home/ansible/.kube/config', true) }}"
  
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
    
  tasks:
    - name: Check if moodle namespace exists
      kubernetes.core.k8s_info:
        kind: Namespace
        name: "{{ moodle_namespace }}"
      register: namespace_info
      ignore_errors: true
      
    - name: Debug namespace_info structure
      debug:
        var: namespace_info
        verbosity: 1
      
    - name: Check if Kubernetes connection is working
      fail:
        msg: |
          Cannot connect to Kubernetes cluster.
          Current KUBECONFIG path: {{ kubeconfig_path }}
          Error: {{ namespace_info.msg | default('Unknown connection error') }}
          
          Please ensure:
          1. The kubeconfig file exists at the specified path
          2. The file has proper permissions
          3. The Kubernetes API server is accessible
          
          You can override the kubeconfig path by setting the KUBECONFIG environment variable:
          KUBECONFIG=/path/to/your/kubeconfig ansible-playbook ...
      when: namespace_info is failed or (namespace_info.get('failed', False) and ("Connection refused" in namespace_info.get('msg', '') or "no such file" in namespace_info.get('msg', '') or "cannot read" in namespace_info.get('msg', '')))
      
    - name: Set namespace existence fact
      set_fact:
        namespace_exists: "{{ (namespace_info.resources | length > 0) if (namespace_info.get('resources') is defined and namespace_info.resources is not none) else (namespace_info.result.items | length > 0) if (namespace_info.get('result') is defined and namespace_info.result.get('items') is defined) else false }}"
        k8s_connection_success: "{{ not (namespace_info.get('failed', False) or namespace_info is failed) }}"
      
    - name: Fail if Kubernetes connection failed
      fail:
        msg: |
          Failed to connect to Kubernetes API.
          Current KUBECONFIG path: {{ kubeconfig_path }}
          Error details: {{ namespace_info | to_nice_json }}
          
          Troubleshooting steps:
          1. Verify kubeconfig file exists: ls -la {{ kubeconfig_path }}
          2. Test connection manually: kubectl --kubeconfig={{ kubeconfig_path }} get nodes
          3. Check file permissions: Ensure readable by ansible user
      when: not k8s_connection_success
      
    - name: Fail if namespace doesn't exist
      fail:
        msg: "Moodle namespace '{{ moodle_namespace }}' does not exist"
      when: not namespace_exists
      
    - name: Check deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        name: moodle
        namespace: "{{ moodle_namespace }}"
      register: deployment_info
      
    - name: Set deployment status fact
      set_fact:
        deployment_available: "{{ (deployment_info.resources[0].status.availableReplicas is defined and deployment_info.resources[0].status.availableReplicas > 0) if (deployment_info.get('resources') is defined and deployment_info.resources is not none and deployment_info.resources | length > 0) else false }}"
        deployment_exists: "{{ (deployment_info.resources | length > 0) if (deployment_info.get('resources') is defined and deployment_info.resources is not none) else false }}"
        
    - name: Check pod status
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ moodle_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=moodle
      register: pod_info
      
    - name: Set pod facts
      set_fact:
        total_pods: "{{ (pod_info.resources | length) if (pod_info.get('resources') is defined and pod_info.resources is not none) else 0 }}"
        ready_pods: "{{ ((pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list) | length) if (pod_info.get('resources') is defined and pod_info.resources is not none and (pod_info.resources | selectattr('status.phase', 'equalto', 'Running') | list)) else 0 }}"
        
    - name: Check service status
      kubernetes.core.k8s_info:
        kind: Service
        name: moodle
        namespace: "{{ moodle_namespace }}"
      register: service_info
      
    - name: Set service facts
      set_fact:
        service_exists: "{{ (service_info.resources | length > 0) if (service_info.get('resources') is defined and service_info.resources is not none) else false }}"
        service_data: "{{ service_info.resources[0] if (service_info.get('resources') is defined and service_info.resources is not none and service_info.resources | length > 0) else {} }}"
        
    - name: Check database secret
      kubernetes.core.k8s_info:
        kind: Secret
        name: moodle-externaldb
        namespace: "{{ moodle_namespace }}"
      register: secret_info
      
    - name: Set secret facts
      set_fact:
        secret_exists: "{{ (secret_info.resources | length > 0) if (secret_info.get('resources') is defined and secret_info.resources is not none) else false }}"
      
    - name: Check configmap
      kubernetes.core.k8s_info:
        kind: ConfigMap
        name: moodle-config-synchronized
        namespace: "{{ moodle_namespace }}"
      register: configmap_info
      ignore_errors: true
      
    - name: Set configmap facts
      set_fact:
        configmap_exists: "{{ (configmap_info.resources | length > 0) if (configmap_info.get('resources') is defined and configmap_info.resources is not none) else false }}"
      
    - name: Display validation results
      debug:
        msg:
          - "=== MOODLE DEPLOYMENT VALIDATION ==="
          - "Namespace: {{ '✓ Present' if namespace_exists else '✗ Missing' }}"
          - "Deployment: {{ '✓ Available' if deployment_available else '✗ Not Available' }}"
          - "Pods: {{ ready_pods }}/{{ total_pods }} ready"
          - "Service: {{ '✓ Present' if service_exists else '✗ Missing' }}"
          - "Database Secret: {{ '✓ Present' if secret_exists else '✗ Missing' }}"
          - "ConfigMap: {{ '✓ Present' if configmap_exists else '✗ Missing' }}"
          - ""
          - "=== ACCESS INFORMATION ==="
          - "NodePort: {{ service_data.spec.ports[0].nodePort | default('Unknown') if service_data.get('spec', {}).get('ports', []) | length > 0 else 'Unknown' }}"
          - "ClusterIP: {{ service_data.spec.clusterIP | default('Unknown') if service_data.get('spec', {}).get('clusterIP') is defined else 'Unknown' }}"
          
    - name: Fail if deployment is not healthy
      fail:
        msg: "Moodle deployment is not healthy. Check the status above."
      when: >
        not deployment_available or
        ready_pods == 0
        
    - name: Success message
      debug:
        msg: "✅ Moodle deployment validation successful!"
      when: >
        deployment_available and
        ready_pods != 0