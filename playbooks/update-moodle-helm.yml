---
- name: Update Moodle Helm Configuration with Correct Settings
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../inventories/prod/group_vars/all.yml
    - ../inventories/prod/group_vars/vault.yml

  tasks:
    - name: Update Moodle Helm release
      kubernetes.core.helm:
        name: "{{ moodle.release_name }}"
        chart_ref: bitnami/moodle
        release_namespace: "{{ moodle.namespace }}"
        kubeconfig: "{{ (kubeconfig is defined and kubeconfig | length > 0) | ternary(kubeconfig, omit) }}"
        values:
          global:
            security:
              allowInsecureImages: true

          image:
            repository: aragawmebratu/moodle-with-tools
            tag: latest

          replicaCount: "{{ moodle.replica_count }}"

          moodleSkipInstall: true

          mariadb:
            enabled: false

          # CORRECT PostgreSQL Pooler Configuration
          externalDatabase:
            host: "moodle-db-cluster-pooler.database.svc.cluster.local"
            port: 5432
            user: "moodleuser"
            password: "PQl5YR30j9geR9NrgLTPxzTBkNZ2OYIDDiLaDZm946Nk7O1mWmPsArY5C7yj9vcw"
            database: "moodledb"
            type: pgsql

          redis:
            enabled: false

          externalRedis:
            host: "{{ dragonfly.host }}"
            port: "{{ dragonfly.port }}"
            password: "{{ dragonfly_password }}"

          moodleUsername: admin
          moodlePassword: "{{ moodle_admin_password }}"
          moodleEmail: admin@example.com

          service:
            type: "{{ moodle.service.type }}"
            nodePort: "{{ moodle.service.nodePort }}"

          persistence:
            enabled: "{{ moodle.persistence.enabled }}"
            size: "{{ moodle.persistence.size }}"
            storageClass: "{{ moodle.persistence.storageClass }}"
            accessModes: "{{ moodle.persistence.accessModes }}"

          resources: "{{ moodle.resources }}"

          extraVolumes:
            - name: config
              configMap:
                name: config
            - name: php-fpm-config
              configMap:
                name: "{{ moodle.php_fpm_config_map | default('moodle-php-fpm-config') }}"

          extraVolumeMounts:
            - name: config
              mountPath: /bitnami/moodle/config.php
              subPath: config.php
              readOnly: true
            - name: php-fpm-config
              mountPath: /opt/bitnami/php/etc/php-fpm.d/www.conf
              subPath: www.conf
              readOnly: true

    - name: Wait for Moodle deployment rollout
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ moodle.namespace }}"
        name: moodle
      register: deployment_status
      until: >
        deployment_status.resources[0].status.updatedReplicas == moodle.replica_count|int and
        deployment_status.resources[0].status.readyReplicas == moodle.replica_count|int
      retries: 30
      delay: 10

    - name: Verify Moodle pods are running
      debug:
        msg: "Moodle deployment updated successfully. Pods should be starting with correct configuration."
