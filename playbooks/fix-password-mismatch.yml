---
- name: Fix PostgreSQL and Moodle Password Mismatch
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../inventories/prod/group_vars/all.yml
    - ../inventories/prod/group_vars/vault.yml

  tasks:
    - name: Get current PostgreSQL password
      kubernetes.core.k8s_info:
        kind: Secret
        namespace: database
        name: postgres-password
      register: postgres_secret

    - name: Decode PostgreSQL password
      set_fact:
        current_postgres_pw: "{{ postgres_secret.resources[0].data.password | b64decode }}"

    - name: Display current PostgreSQL password
      debug:
        msg: "Current PostgreSQL password: {{ current_postgres_pw }}"

    - name: Check if PostgreSQL password is corrupted
      set_fact:
        password_is_corrupted: "{{ 'kubectl' in current_postgres_pw or 'create' in current_postgres_pw or 'namespace' in current_postgres_pw }}"

    - name: Set correct password
      set_fact:
        correct_password: "PQl5YR30j9geR9NrgLTPxzTBkNZ2OYIDDiLaDZm946Nk7O1mWmPsArY5C7yj9vcw"

    - name: Update PostgreSQL password in database
      kubernetes.core.k8s_exec:
        namespace: database
        pod: "moodle-db-cluster-0"
        command:
          - psql
          - -U
          - postgres
          - -c
          - "ALTER USER moodleuser WITH PASSWORD '{{ correct_password }}';"
        stdin_add_newline: false
      when: password_is_corrupted

    - name: Update PostgreSQL secret
      kubernetes.core.k8s:
        state: present
        namespace: database
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: postgres-password
            namespace: database
          type: Opaque
          data:
            password: "{{ correct_password | b64encode }}"
            replication-password: "{{ correct_password | b64encode }}"

    - name: Update Moodle database secret
      kubernetes.core.k8s:
        state: present
        namespace: "{{ moodle.namespace }}"
        definition:
          apiVersion: v1
          kind: Secret
          metadata:
            name: moodle-externaldb
            namespace: "{{ moodle.namespace }}"
          type: Opaque
          data:
            password: "{{ correct_password | b64encode }}"

    - name: Update config.php with correct password
      kubernetes.core.k8s:
        state: present
        namespace: "{{ moodle.namespace }}"
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: config
            namespace: "{{ moodle.namespace }}"
          data:
            config.php: |
              <?php
              unset($CFG);
              global $CFG;
              $CFG = new stdClass();

              // Database configuration - USING POOLER
              $CFG->dbtype    = 'pgsql';
              $CFG->dblibrary = 'native';
              $CFG->dbhost    = 'moodle-db-cluster-pooler.database.svc.cluster.local';
              $CFG->dbname    = 'moodledb';
              $CFG->dbuser    = 'moodleuser';
              $CFG->dbpass    = '{{ correct_password }}';
              $CFG->prefix    = 'mdl_';

              // Optimized database options
              $CFG->dboptions = array (
                'dbpersist' => 1,
                'dbport' => 5432,
                'dbsocket' => '',
                'connecttimeout' => 3,
                'connectretries' => 2,
                'fetchbuffersize' => 100000,
              );

              if (empty($_SERVER['HTTP_HOST'])) {
                $_SERVER['HTTP_HOST'] = '127.0.0.1:8080';
              }
              if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') {
                $CFG->wwwroot = 'https://' . $_SERVER['HTTP_HOST'];
              } else {
                $CFG->wwwroot = 'http://' . $_SERVER['HTTP_HOST'];
              }
              $CFG->dataroot  = '/bitnami/moodledata';
              $CFG->admin     = 'admin';
              $CFG->directorypermissions = 02775;

              /* ===== Redis / Dragonfly ===== */
              $CFG->session_handler_class = '\core\session\redis';
              $CFG->session_redis_host = 'dragonfly-redis-master.dragonfly-system.svc.cluster.local';
              $CFG->session_redis_port = 6379;
              $CFG->session_redis_auth = 'dragonfly';
              $CFG->session_redis_database = 0;
              $CFG->session_redis_prefix = 'moodle_sess_';
              $CFG->session_redis_acquire_lock_timeout = 120;

              /* Application cache */
              $CFG->redis_host = 'dragonfly-redis-master.dragonfly-system.svc.cluster.local';
              $CFG->redis_port = 6379;
              $CFG->redis_password = 'dragonfly';
              $CFG->redis_prefix = 'moodle_cache_';

              /* ===== PERFORMANCE OPTIMIZATIONS ===== */
              $CFG->debug = 0;
              $CFG->debugdisplay = false;
              $CFG->perfdebug = 0;
              $CFG->showcrondebugging = false;
              $CFG->cachejs = true;
              $CFG->cachetemplates = true;
              $CFG->themedesignermode = false;
              $CFG->filecaches = true;
              $CFG->filelifetime = 86400;
              $CFG->session_update_timemodified_frequency = 60;
              $CFG->cronclionly = true;
              $CFG->extramemorylimit = '512M';
              $CFG->maxtimelimit = 180;

              require_once(__DIR__ . '/lib/setup.php');