---
- name: Configure Horizontal Pod Autoscaling for Moodle
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    moodle_namespace: moodle
    moodle_deployment: moodle
    # HPA configuration
    hpa_min_replicas: 3
    hpa_max_replicas: 30
    hpa_cpu_threshold: 70
    hpa_memory_threshold: 70

  tasks:
    - name: Display HPA configuration plan
      debug:
        msg: |
          Configuring Horizontal Pod Autoscaler for Moodle:
          - Minimum replicas: {{ hpa_min_replicas }}
          - Maximum replicas: {{ hpa_max_replicas }}
          - CPU threshold: {{ hpa_cpu_threshold }}%
          - Memory threshold: {{ hpa_memory_threshold }}%
          - Target deployment: {{ moodle_deployment }} in namespace {{ moodle_namespace }}

    - name: Check if metrics server is available
      kubernetes.core.k8s_info:
        kind: Deployment
        name: metrics-server
        namespace: kube-system
      register: metrics_server
      ignore_errors: true

    - name: Warn if metrics server is not available
      debug:
        msg: |
          WARNING: Metrics server not found in kube-system namespace.
          HPA requires metrics server to function properly.
          Please ensure metrics server is installed in your cluster.
      when: metrics_server.resources | length == 0

    - name: Create HorizontalPodAutoscaler
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: autoscaling/v2
          kind: HorizontalPodAutoscaler
          metadata:
            name: "{{ moodle_deployment }}-hpa"
            namespace: "{{ moodle_namespace }}"
          spec:
            scaleTargetRef:
              apiVersion: apps/v1
              kind: Deployment
              name: "{{ moodle_deployment }}"
            minReplicas: "{{ hpa_min_replicas }}"
            maxReplicas: "{{ hpa_max_replicas }}"
            metrics:
            - type: Resource
              resource:
                name: cpu
                target:
                  type: Utilization
                  averageUtilization: "{{ hpa_cpu_threshold }}"
            - type: Resource
              resource:
                name: memory
                target:
                  type: Utilization
                  averageUtilization: "{{ hpa_memory_threshold }}"
            behavior:
              scaleDown:
                stabilizationWindowSeconds: 300
                policies:
                - type: Percent
                  value: 10
                  periodSeconds: 60
              scaleUp:
                stabilizationWindowSeconds: 60
                policies:
                - type: Percent
                  value: 50
                  periodSeconds: 60
                - type: Pods
                  value: 4
                  periodSeconds: 60
                selectPolicy: Max

    - name: Verify HPA creation
      kubernetes.core.k8s_info:
        kind: HorizontalPodAutoscaler
        name: "{{ moodle_deployment }}-hpa"
        namespace: "{{ moodle_namespace }}"
      register: hpa_status

    - name: Display HPA status
      debug:
        msg: |
          HorizontalPodAutoscaler created successfully:
          - Name: {{ hpa_status.resources[0].metadata.name }}
          - Min replicas: {{ hpa_status.resources[0].spec.minReplicas }}
          - Max replicas: {{ hpa_status.resources[0].spec.maxReplicas }}
          - Current replicas: {{ hpa_status.resources[0].status.currentReplicas | default('Unknown') }}
          - Desired replicas: {{ hpa_status.resources[0].status.desiredReplicas | default('Unknown') }}

    - name: Display scaling policies
      debug:
        msg: |
          Scaling policies configured:
          Scale Up:
            - 50% of current replicas per minute (max)
            - Or 4 pods per minute (whichever is higher)
            - 60 second stabilization window
          
          Scale Down:
            - 10% of current replicas per minute
            - 300 second stabilization window
            - Prevents rapid scaling oscillations

    - name: Test HPA configuration
      command: |
        kubectl get hpa {{ moodle_deployment }}-hpa -n {{ moodle_namespace }} -o wide
      register: hpa_info

    - name: Display HPA information
      debug:
        msg: |
          HPA Details:
          {{ hpa_info.stdout }}

    - name: Success message
      debug:
        msg: |
          âœ… Horizontal Pod Autoscaler configured successfully!
          
          Your Moodle deployment will now automatically scale based on resource usage:
          - Scales up when CPU or memory usage exceeds {{ hpa_cpu_threshold }}%
          - Scales down when resource usage drops below threshold
          - Maintains between {{ hpa_min_replicas }} and {{ hpa_max_replicas }} pods
          - Includes smart scaling policies to prevent thrashing
          
          Monitor scaling activity with:
          kubectl get hpa -n {{ moodle_namespace }}
          kubectl describe hpa {{ moodle_deployment }}-hpa -n {{ moodle_namespace }}