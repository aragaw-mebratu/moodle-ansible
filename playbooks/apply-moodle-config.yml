# playbooks/apply-moodle-config.yml (updated)
---
- name: Apply Moodle ConfigMaps
  hosts: localhost
  gather_facts: false
  vars_files:
    - ../inventories/prod/group_vars/all.yml
    - ../inventories/prod/group_vars/vault.yml
  tasks:
    - name: Create Moodle PHP-FPM ConfigMap
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('template', 'php-fpm-configmap.yml') | from_yaml }}"
        kubeconfig: "{{ (kubeconfig is defined and kubeconfig | length > 0) | ternary(kubeconfig, omit) }}"

    - name: Create config ConfigMap from template
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: config
            namespace: "{{ moodle.namespace }}"
          data:
            config.php: |
              {{ lookup('template', '../templates/config.php.j2') | indent(14) }}
        kubeconfig: "{{ (kubeconfig is defined and kubeconfig | length > 0) | ternary(kubeconfig, omit) }}"
