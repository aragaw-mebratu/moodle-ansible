---
- name: Tune PHP-FPM for Moodle dynamically
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    moodle_namespace: moodle
    php_fpm_conf_path: "/opt/bitnami/php/etc/php-fpm.d/www.conf"
    
    pm_type: "dynamic"
    max_children: 500
    start_servers: 50
    min_spare_servers: 50
    max_spare_servers: 100
    max_requests: 1000
    moodle_label_selector: "app=moodle"

  tasks:
    - name: Discover Moodle pods using Kubernetes Python client
      community.kubernetes.k8s_info:
        kind: Pod
        namespace: "{{ moodle_namespace }}"
        label_selectors:
          - "{{ moodle_label_selector }}"
      register: moodle_pods_info

    - name: Set Moodle pods list
      set_fact:
        moodle_pods: "{{ moodle_pods_info.resources | map(attribute='metadata.name') | list }}"

    - name: Backup www.conf inside each Moodle pod
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ item }}"
        command:
          - cp
          - "{{ php_fpm_conf_path }}"
          - "{{ php_fpm_conf_path }}.bak"
      loop: "{{ moodle_pods }}"

    - name: Update PHP-FPM settings inside Moodle pods
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ item }}"
        command:
          - bash
          - -c
          - |
            sed -i 's/^pm\s*=.*/pm = {{ pm_type }}/' {{ php_fpm_conf_path }}
            sed -i 's/^pm.max_children\s*=.*/pm.max_children = {{ max_children }}/' {{ php_fpm_conf_path }}
            sed -i 's/^pm.start_servers\s*=.*/pm.start_servers = {{ start_servers }}/' {{ php_fpm_conf_path }}
            sed -i 's/^pm.min_spare_servers\s*=.*/pm.min_spare_servers = {{ min_spare_servers }}/' {{ php_fpm_conf_path }}
            sed -i 's/^pm.max_spare_servers\s*=.*/pm.max_spare_servers = {{ max_spare_servers }}/' {{ php_fpm_conf_path }}
            sed -i 's/^;*pm.max_requests\s*=.*/pm.max_requests = {{ max_requests }}/' {{ php_fpm_conf_path }}
      loop: "{{ moodle_pods }}"

    - name: Reload PHP-FPM inside each Moodle pod
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ item }}"
        command:
          - systemctl
          - reload
          - php-fpm
      loop: "{{ moodle_pods }}"

    - name: Show completed message
      debug:
        msg: "PHP-FPM tuning applied successfully to pods: {{ moodle_pods }}"