---
- name: Tune PHP-FPM for Moodle dynamically
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    moodle_namespace: moodle
    moodle_container: moodle   # ðŸ‘ˆ IMPORTANT (Bitnami container name)
    php_fpm_conf_path: /opt/bitnami/php/etc/php-fpm.d/www.conf

    pm_type: dynamic
    max_children: 500
    start_servers: 50
    min_spare_servers: 50
    max_spare_servers: 100
    max_requests: 1000

  tasks:
    - name: Discover Moodle pods
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ moodle_namespace }}"
        label_selectors:
          - app.kubernetes.io/name=moodle
      register: moodle_pods_info

    - name: Extract pod names
      set_fact:
        moodle_pods: "{{ moodle_pods_info.resources | map(attribute='metadata.name') | list }}"

    - debug:
        var: moodle_pods

    - name: Test exec access
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ moodle_pods[0] }}"
        container: "{{ moodle_container }}"
        command:
          - sh
          - -c
          - "id && ls /opt/bitnami/php/etc/php-fpm.d"
      register: exec_test

    - debug:
        var: exec_test.stdout_lines

    - name: Update PHP-FPM config
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ item }}"
        container: "{{ moodle_container }}"
        command:
          - sh
          - -c
          - |
            set -e
            CONFIG="{{ php_fpm_conf_path }}"
            cp "$CONFIG" "$CONFIG.bak"

            sed -i \
              -e "s/^pm =.*/pm = {{ pm_type }}/" \
              -e "s/^pm.max_children =.*/pm.max_children = {{ max_children }}/" \
              -e "s/^pm.start_servers =.*/pm.start_servers = {{ start_servers }}/" \
              -e "s/^pm.min_spare_servers =.*/pm.min_spare_servers = {{ min_spare_servers }}/" \
              -e "s/^pm.max_spare_servers =.*/pm.max_spare_servers = {{ max_spare_servers }}/" \
              -e "s/^;*pm.max_requests =.*/pm.max_requests = {{ max_requests }}/" \
              "$CONFIG"

            echo "Updated PHP-FPM config:"
            grep '^pm' "$CONFIG"
      loop: "{{ moodle_pods }}"

    - name: Verify PHP-FPM config
      kubernetes.core.k8s_exec:
        namespace: "{{ moodle_namespace }}"
        pod: "{{ item }}"
        container: "{{ moodle_container }}"
        command:
          - sh
          - -c
          - |
            echo "---- {{ item }} ----"
            grep '^pm' "{{ php_fpm_conf_path }}"
      loop: "{{ moodle_pods }}"

    - name: Reminder
      debug:
        msg: >
          PHP-FPM config updated inside running pods.
          NOTE: Changes will be LOST if pods restart.
          Use ConfigMaps or Helm for persistence.
