<?php
unset($CFG);
global $CFG;
$CFG = new stdClass();

// Database configuration - DIRECT CONNECTION (no pooler)
$CFG->dbtype    = 'pgsql';
$CFG->dblibrary = 'native';
$CFG->dbhost    = '{{ db_host | default("moodle-db-cluster.database.svc.cluster.local") }}';
$CFG->dbname    = '{{ db_name | default("moodledb") }}';
$CFG->dbuser    = '{{ db_user | default("moodleuser") }}';
$CFG->dbpass    = '{{ db_password | default("PQl5YR30j9geR9NrgLTPxzTBkNZ2OYIDDiLaDZm946Nk7O1mWmPsArY5C7yj9vcw") }}';
$CFG->prefix    = 'mdl_';

// Optimized database options for direct connection
$CFG->dboptions = array (
  'dbpersist' => 1,
  'dbport' => {{ db_port | default(5432) }},
  'dbsocket' => '',
  'connecttimeout' => 3,
  'connectretries' => 2,
  'fetchbuffersize' => 100000,
);

// URL detection (UNCHANGED)
if (empty($_SERVER['HTTP_HOST'])) {
  $_SERVER['HTTP_HOST'] = '127.0.0.1:8080';
}
if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') {
  $CFG->wwwroot = 'https://' . $_SERVER['HTTP_HOST'];
} else {
  $CFG->wwwroot = 'http://' . $_SERVER['HTTP_HOST'];
}

// Core paths (UNCHANGED)
$CFG->dataroot  = '/bitnami/moodledata';
$CFG->admin     = 'admin';
$CFG->directorypermissions = 02775;

/* ===== Redis / Dragonfly ===== */
// Session handling
$CFG->session_handler_class = '\\core\\session\\redis';
$CFG->session_redis_host = '{{ redis_host | default("dragonfly-redis-master.dragonfly-system.svc.cluster.local") }}';
$CFG->session_redis_port = {{ redis_port | default(6379) }};
$CFG->session_redis_auth = '{{ redis_password | default("dragonfly") }}';
$CFG->session_redis_database = 0;
$CFG->session_redis_prefix = 'moodle_sess_';
$CFG->session_redis_acquire_lock_timeout = 120;

/* Application cache */
$CFG->redis_host = '{{ redis_host | default("dragonfly-redis-master.dragonfly-system.svc.cluster.local") }}';
$CFG->redis_port = {{ redis_port | default(6379) }};
$CFG->redis_password = '{{ redis_password | default("dragonfly") }}';
$CFG->redis_prefix = 'moodle_cache_';

/* ===== PERFORMANCE OPTIMIZATIONS (ADDED) ===== */
// Debug settings - keep minimal for production
$CFG->debug = 0;
$CFG->debugdisplay = false;
$CFG->perfdebug = 0;
$CFG->showcrondebugging = false;

// Caching optimizations
$CFG->cachejs = true;
$CFG->cachetemplates = true;
$CFG->themedesignermode = false;

// File caching
$CFG->filecaches = true;
$CFG->filelifetime = 86400;

// Session optimizations
$CFG->session_update_timemodified_frequency = 60; // Update session every minute instead of every request

// Cron optimization
$CFG->cronclionly = true;

// Memory and timeout settings
$CFG->extramemorylimit = '512M';
$CFG->maxtimelimit = 180;

// Optional: Enable Redis for MUC (Moodle Universal Cache)
// Uncomment if you want to use Redis for all caching
/*
$CFG->alternative_cache_factory_class = 'cache_factory';
$CFG->cachestores = array(
    'redis' => array(
        'name' => 'redis',
        'plugin' => 'redis',
        'configuration' => array(
            'server' => 'dragonfly-redis-master.dragonfly-system.svc.cluster.local:6379',
            'prefix' => 'moodle_muc_',
            'password' => 'dragonfly',
            'serializer' => 'php',
            'compressor' => 'none',
            'ttl' => 0,
        ),
        'features' => 14, // All features
    ),
);
$CFG->cache_factory_class = 'cachestore_redis';
*/

require_once(__DIR__ . '/lib/setup.php');